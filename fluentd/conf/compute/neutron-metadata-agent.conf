# TIMESTAMP {date time} LEVEL  API   [] MESSAGE

<source>
    @type tail
    path /var/log/neutron/neutron-metadata-agent.log
    pos_file /tmp/neutron-metadata-agent.log.pos
    <parse>
        @type grok
        grok_pattern %{NEUTRONMETA}
        custom_pattern_path /fluentd/etc/conf/pattern
    </parse>
    tag neutron.metadata
</source>

<filter neutron.metadata>
    @type record_transformer
    enable_ruby
    <record>
        hostname "#{Socket.gethostname}"
        ip "#{(Socket.ip_address_list.detect do |intf| intf.ipv4_private? end).ip_address}"
        service ${tag_parts[0]}-${tag_parts[1]}
        # request ${request.gsub!("\u001b".encode('utf-8'), "");request.gsub(/\[0[0-2](;[0-9]{2})?m/, '')}
        # message ${message.gsub!("\u001b".encode('utf-8'), "");message.gsub(/\[0[0-2](;[0-9]{2})?m/, '')}
        #timestamp ${timestamp.gsub!(" ", "T");timestamp.gsub(/\.\d*/, "+05:30")}      # 2015-11-04T13:54:44+05:30
    </record>
</filter>

<match neutron.metadata>
    @type retag
    add_prefix compute.openstack
</match>
